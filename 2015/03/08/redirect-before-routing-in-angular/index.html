<!DOCTYPE html><head><meta charset="utf-8"><title>Angular条件路由 | 刘哇勇的部落格</title><meta content="width=device-width,initial-scale=1" name="viewport"><meta name="theme-color" content="#4184f3"><link href="/favicon.ico" rel="icon"><link rel="stylesheet" href="/css/highlight.light.css"><link rel="stylesheet" href="/css/prism-customize.css"><link rel="stylesheet" href="/css/nav-icon.css"><link rel="stylesheet" href="/css/waves.min.css"><link rel="stylesheet" href="/css/jquery.tocify.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/nav-indicator.css"></head><body><header></header><div id="main" class="m-scene"><div class="nav-wrapper"><div class="container"><nav><div class="logo wave"><a href="/" id="logo">刘哇勇的部落格</a></div><div class="nav-toggle-icon"><div class="material-hamburger"><span></span> <span></span> <span></span></div></div><div class="menu-wrapper"><div class="nav-indicator"></div><ul class="menus"><li><a class="wave" href="/">首页</a></li><li><a class="wave" href="/archives">归档</a></li><li><a class="wave" href="/about">关于</a></li><li><a class="wave no-smoothstate" href="/atom.xml">订阅</a></li></ul></div></nav></div></div><div class="container content"><div class="scene_element scene_element--fadein"><div class="row"><div class="main"><article><header class="post-header"></header><h1 class="post-title">Angular条件路由</h1><section class="post-info"><span class="post-date">2015/03/08</span> <span class="post-category"><a class="article-category-link" href="/categories/技术/">技术</a> </span><span class="post-tags"><ul class="post-tag-list"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/anular/">anular</a></li></ul></span></section><section class="post-content"><p>对于Web程序通常会有这样的需求：针对不同的情况，我们希望用户进入站点后打开不同的页面。<br>写一下Web程序的时候，会有这样的需求：根据用户的类型，将用户导向不同的页面。<br>譬如，对于非注册用户，打开站点后导向到注册页面;<br>或者，以之前做的一个项目为例，对于普通用户，打开培训页面，而培训合格的用户，我们希望默认打开管理页面。</p><p>这样的路由控制当然可以由后端来做。</p><a id="more"></a><p>当使用了Angular这样的前端框架时，路由由前端控制并且是事先配好的（当然，这种情况下也不是说后端就不能控制路由了）。<br>一个典型的angular示例如下面代码所示：</p><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> app <span class="token operator">=</span> angular<span class="token punctuation">.</span><span class="token function">module</span><span class="token punctuation">(</span><span class="token string">'myApp'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'$routeProvider'</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span>$routeProvider<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        $routeProvider<span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">//培训页面</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            templateUrl<span class="token punctuation">:</span> <span class="token string">'views/home.html'</span><span class="token punctuation">,</span>
            controller<span class="token punctuation">:</span> <span class="token string">'HomeCtrl'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">//管理</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token string">'/auth'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            templateUrl<span class="token punctuation">:</span> <span class="token string">'views/auth.html'</span><span class="token punctuation">,</span>
            controller<span class="token punctuation">:</span> <span class="token string">'AuthCtrl'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">otherwise</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            redirectTo<span class="token punctuation">:</span> <span class="token string">'/'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>这里不深入讨论完整的权限控制，用户当然可以手动更改URL来打开管理页面，但你可以选择不展示内容而是给个提示“无权限”之类的，总之这里不讨论，这里要说的就是我们有能力根据条件更改Angular路由的默认页面。</p><p>如果我们不做作何处理，根据现在的配置，默认是打开培训页面。为了对已经通过培训的用户默认打开管理页面，首先我们要知道当前用户的身份，然后判断是否该跳转。</p><p>Angular模块的<code>run</code>函数，是最接近主程序启动的地方，可以在这里进行判断与重定向。<br>所以更新后的代码如下：</p><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> app <span class="token operator">=</span> angular<span class="token punctuation">.</span><span class="token function">module</span><span class="token punctuation">(</span><span class="token string">'myApp'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'$routeProvider'</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span>$routeProvider<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        $routeProvider<span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">//首页</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            templateUrl<span class="token punctuation">:</span> <span class="token string">'views/home.html'</span><span class="token punctuation">,</span>
            controller<span class="token punctuation">:</span> <span class="token string">'HomeCtrl'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">//注册页</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token string">'/auth'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            templateUrl<span class="token punctuation">:</span> <span class="token string">'views/auth.html'</span><span class="token punctuation">,</span>
            controller<span class="token punctuation">:</span> <span class="token string">'AuthCtrl'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">otherwise</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            redirectTo<span class="token punctuation">:</span> <span class="token string">'/'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'$location'</span><span class="token punctuation">,</span> <span class="token string">'$http'</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span>$location<span class="token punctuation">,</span> $http<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        $http<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'path/to/get/user/data'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">success</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//拿到用户数据，判断用户类型，然后定位到相应的页面</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>member<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//如果是合格用户，转向管理页面</span>
                $location<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">'/auth'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>向模块添加<code>run</code>函数，首先发起一个请求获取用户数据，根据返回的数据进行判断，然后使用<code>$location.path</code>来重新路由。</p><h2 id="参考及引用"><a href="/2015/03/08/redirect-before-routing-in-angular/#参考及引用" class="headerlink" title="参考及引用"></a>参考及引用</h2><ul><li><a href="https://docs.angularjs.org/guide/module" target="_blank" rel="external">Angular Modeule Run Blocks</a></li></ul><link href="/css/prism.css" rel="stylesheet"></section></article><div class="pager"><a class="post-prev pager-item" href="/2016/01/01/batch-convert-text-encoding-from-gbk-2-utf8/"><strong class="article-nav-caption">上一篇</strong><p class="post-nav-title">gbk批量转utf8</p></a><a class="post-next pager-item" href="/2015/01/18/all-this/"><strong class="article-nav-caption">下一篇</strong><p class="post-nav-title">详解this</p></a></div><div class="comment-section"><div class="ds-thread" data-thread-key="_posts/2015-03-08-redirect-before-routing-in-angular.md" data-title="Angular条件路由" data-url="http://wayou.js.org/2015/03/08/redirect-before-routing-in-angular/"></div><script type="text/javascript">var duoshuoQuery={short_name:"wayouliu"};!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https:":"http:")+"//static.duoshuo.com/embed.js",t.charset="UTF-8",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)}()</script></div></div></div></div></div></div><footer class="footer"><p>由<a href="http://hexo.io/" target="_blank">Hexo</a>强力驱动，搭载<a href="https://github.com/wayou/hexo-theme-gstyle">gstyle</a>主题</p><p>&copy; 2016 Wayou Liu</p></footer><script src="/lib/jquery.js"></script><script src="/lib/waves.js"></script><script src="/lib/jquery-ui.js"></script><script src="/lib/jquery.tocify.js"></script><script src="/js/main.js"></script></body>