"use strict";var estraverse=require("estraverse");var docs=require("./docs");var esutil=require("./esutil");var jsdoc=require("./jsdoc");var analyzeProperties=require("./analyze-properties");var astValue=require("./ast-value.js");var numFeatures=0;module.exports=function e(){var e=[];var r=null;var t={properties:function(e){var t=analyzeProperties(e);for(var i=0;i<t.length;i++){r.properties.push(t[i])}}};function i(r){var t=function(e){return e.indexOf(r.is)===-1};for(var i=0;i<e.length;i++){if(r.is!==e[i].is)continue;if(r.desc){if(e[i].desc){if(r.desc.length>e[i].desc.length)e[i].desc=r.desc}else{e[i].desc=r.desc}}e[i].demos=(e[i].demos||[]).concat(r.demos||[]);e[i].events=(e[i].events||[]).concat(r.events||[]);e[i].properties=(e[i].properties||[]).concat(r.properties||[]);e[i].behaviors=(e[i].behaviors||[]).concat(r.behaviors||[]).filter(t);return e[i]}return r}var s={enterVariableDeclaration:function(e,r){if(e.declarations.length!==1)return;this._initBehavior(e,function(){return esutil.objectKeyToString(e.declarations[0].id)})},enterAssignmentExpression:function(e,r){this._initBehavior(r,function(){return esutil.objectKeyToString(e.left)})},_parseChainedBehaviors:function(e){var t;switch(e.type){case"ExpressionStatement":t=e.expression.right;break;case"VariableDeclaration":t=e.declarations.length>0?e.declarations[0].init:null;break}var i=[];if(t&&t.type==="ArrayExpression"){for(var s=0;s<t.elements.length;s++){if(t.elements[s].type==="MemberExpression")i.push(astValue.expressionToValue(t.elements[s]))}if(i.length>0)r.behaviors=i}},_initBehavior:function(e,t){var s=esutil.getAttachedComment(e);if(!s||s.indexOf("@polymerBehavior")===-1)return;r={type:"behavior",desc:s,events:esutil.getEventComments(e).map(function(e){return{desc:e}})};docs.annotateBehavior(r);if(!jsdoc.hasTag(r.jsdoc,"polymerBehavior")){r=null;return}var n=jsdoc.getTag(r.jsdoc,"polymerBehavior","name");if(!n){n=t()}if(!n){console.warn("Unable to determine name for @polymerBehavior:",s)}r.is=n;this._parseChainedBehaviors(e);r=i(r)},enterObjectExpression:function(i,s){if(!r||r.properties)return;r.properties=r.properties||[];for(var n=0;n<i.properties.length;n++){var o=i.properties[n];var a=esutil.objectKeyToString(o.key);if(!a){throw{message:"Cant determine name for property key.",location:i.loc.start}}if(a in t){t[a](o.value)}else{r.properties.push(esutil.toPropertyDescriptor(o))}}e.push(r);r=null}};return{visitors:s,behaviors:e}};