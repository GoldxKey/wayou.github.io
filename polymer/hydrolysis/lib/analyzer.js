"use strict";var Promise=global.Promise||require("es6-promise").Promise;require("setimmediate");var dom5=require("dom5");var url=require("url");var docs=require("./ast-utils/docs");var FileLoader=require("./loader/file-loader");var importParse=require("./ast-utils/import-parse");var jsParse=require("./ast-utils/js-parse");var NoopResolver=require("./loader/noop-resolver");function reduceMetadata(e,t){return{elements:e.elements.concat(t.elements),features:e.features.concat(t.features),behaviors:e.behaviors.concat(t.behaviors)}}var EMPTY_METADATA={elements:[],features:[],behaviors:[]};var Analyzer=function e(t,r){this.loader=r;this.elements=[];this.elementsByTagName={};this.features=[];this.behaviors=[];this.html={};this.parsedDocuments={}};Analyzer.analyze=function t(e,r){r=r||{};r.filter=r.filter||_defaultFilter(e);var n=new FileLoader;var i=typeof window==="undefined"?require("./loader/fs-resolver"):require("./loader/xhr-resolver");n.addResolver(new i(r));n.addResolver(new NoopResolver({test:r.filter}));var o=new this(null,n);return o.metadataTree(e).then(function(e){if(!r.noAnnotations){o.annotate()}if(r.clean){o.clean()}return Promise.resolve(o)})};function _defaultFilter(e){var t=e.match(/^(.*?)[^\/\\]*$/)[1];return function(e){return e.indexOf(t)!==0}}Analyzer.prototype.load=function r(e){return this.loader.request(e).then(function(t){return new Promise(function(r,n){setImmediate(function(){r(this._parseHTML(t,e))}.bind(this))}.bind(this))}.bind(this))};Analyzer.prototype._parseHTML=function n(e,t){if(t in this.html){return this.html[t]}var r=[];var n=[];var i=Promise.resolve(EMPTY_METADATA);var o;try{o=importParse(e,t)}catch(s){console.error("Error parsing!");throw s}var a=Promise.resolve(o);if(o.script){i=this._processScripts(o.script,t);r.push(i)}if(this.loader){var u=t;if(o.base.length>1){console.error("Only one base tag per document!");throw"Multiple base tags in "+t}else if(o.base.length==1){var l=dom5.getAttribute(o.base[0],"href");if(l){l=l+"/";u=url.resolve(u,l)}}o.import.forEach(function(e){var i=dom5.getAttribute(e,"href");if(i){var o=url.resolve(u,i);n.push(o);r.push(this._dependenciesLoadedFor(o,t))}}.bind(this))}r=Promise.all(r).then(function(){return n}).catch(function(e){throw e});this.parsedDocuments[t]=o.ast;this.html[t]={href:t,htmlLoaded:a,metadataLoaded:i,depHrefs:n,depsLoaded:r};return this.html[t]};Analyzer.prototype._processScripts=function i(e,t){var r=[];e.forEach(function(e){r.push(this._processScript(e,t))}.bind(this));return Promise.all(r).then(function(e){return e.reduce(reduceMetadata,EMPTY_METADATA)})};Analyzer.prototype._processScript=function o(e,t){var r=dom5.getAttribute(e,"src");var n;if(!r){try{n=jsParse(e.childNodes[0].value)}catch(i){var o=0;var s=0;if(e.__ownerDocument&&e.__ownerDocument==t){o=e.__locationDetail.line-1;s=e.__locationDetail.line-1}o+=i.lineNumber;s+=i.column;var a="Error parsing script in "+t+" at "+o+":"+s;a+="\n"+i.description;throw new Error(a)}if(n.elements){n.elements.forEach(function(t){t.scriptElement=e;this.elements.push(t);if(t.is in this.elementsByTagName){console.warn("Ignoring duplicate element definition: "+t.is)}else{this.elementsByTagName[t.is]=t}}.bind(this))}if(n.features){this.features=this.features.concat(n.features)}if(n.behaviors){this.behaviors=this.behaviors.concat(n.behaviors)}return n}if(this.loader){var u=url.resolve(t,r);return this.loader.request(u).then(function(r){var n=Object.create(e);n.childNodes=[{value:r}];n.attrs=n.attrs.slice();dom5.removeAttribute(n,"src");return this._processScript(n,t)}.bind(this)).catch(function(e){throw e})}else{return Promise.resolve(EMPTY_METADATA)}};Analyzer.prototype._dependenciesLoadedFor=function s(e,t){var r={};if(t!==undefined){r[t]=true}return this._getDependencies(e,r).then(function(e){var t=[];var r=e.map(function(e){return this.load(e).then(function(e){return e.metadataLoaded})}.bind(this));return Promise.all(r)}.bind(this))};Analyzer.prototype._getDependencies=function a(e,t,r){if(t===undefined){t={};t[e]=true}if(r===undefined){r=true}var n=[];return this.load(e).then(function(e){var i=[];e.depHrefs.forEach(function(e){if(t[e]){return}n.push(e);t[e]=true;if(r){i.push(this._getDependencies(e,t))}}.bind(this));return Promise.all(i)}.bind(this)).then(function(e){var t=e.reduce(function(e,t){return e.concat(t)},[]).concat(n);return t})};Analyzer.prototype.metadataTree=function u(e){return this.load(e).then(function(t){var r={};r[e]=true;return this._metadataTree(t,r)}.bind(this))};Analyzer.prototype._metadataTree=function l(e,t){if(t===undefined){t={}}return e.metadataLoaded.then(function(r){r={elements:r.elements,features:r.features,href:e.href};return e.depsLoaded.then(function(n){var i=[];n.forEach(function(e){var r=Promise.resolve(true);if(i.length>0){r=i[i.length-1]}r=r.then(function(){if(!t[e]){t[e]=true;return this._metadataTree(this.html[e],t)}else{return Promise.resolve({})}}.bind(this));i.push(r)}.bind(this));return Promise.all(i).then(function(t){r.imports=t;return e.htmlLoaded.then(function(e){r.html=e;if(r.elements){r.elements.forEach(function(t){attachDomModule(e,t)})}return r})})}.bind(this))}.bind(this))};Analyzer.prototype.nodeWalkDocuments=function h(e){var t=[];for(var r in this.parsedDocuments){var n=dom5.nodeWalkAll(this.parsedDocuments[r],e);t=t.concat(n)}return t};Analyzer.prototype.annotate=function c(){if(this.features.length>0){var e=docs.featureElement(this.features);this.elements.unshift(e);this.elementsByTagName[e.is]=e}this.elements.forEach(docs.annotateElement);this.behaviors.forEach(docs.annotateElement)};function attachDomModule(e,t){var r=e["dom-module"];for(var n=0,i;n<r.length;n++){i=r[n];if(dom5.getAttribute(i,"id")===t.is){t.domModule=i;return}}}Analyzer.prototype.clean=function d(){this.elements.forEach(docs.cleanElement)};module.exports=Analyzer;